<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Money, Crime & Love: An Idiom Storybook</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a1a; /* Dark background */
        }
        .idiom-card {
            perspective: 1000px;
        }
        .idiom-card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }
        .idiom-card.is-flipped .idiom-card-inner {
            transform: rotateY(180deg);
        }
        .idiom-card-front, .idiom-card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            display: flex;
            flex-direction: column;
            border-radius: 0.75rem; /* rounded-xl */
        }
        .idiom-card-front {
            justify-content: center;
            align-items: center;
        }
        .idiom-card-back {
            transform: rotateY(180deg);
        }
        h1, h2 {
             font-family: 'Playfair Display', serif;
        }
        .loader {
            width: 24px;
            height: 24px;
            border: 3px solid rgba(255,255,255,0.2);
            border-top: 3px solid #c4b5fd; /* Light purple */
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .gemini-output {
            transition: max-height 0.5s ease-in-out;
            max-height: 0;
            overflow: hidden;
        }
    </style>
</head>
<body class="text-gray-200">

    <div class="container mx-auto p-4 sm:p-8">
        <header class="text-center mb-10">
            <h1 class="text-4xl md:text-6xl font-bold text-white">Money, Crime & Love</h1>
            <p class="mt-3 text-lg text-gray-400 max-w-2xl mx-auto">An Interactive Idiom Storybook. Click on a card to flip it and uncover a story.</p>
        </header>

        <main id="idiom-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            <!-- Idiom cards will be dynamically inserted here -->
        </main>

        <!-- Krea.ai Section -->
        <section class="mt-16 bg-gray-800 p-8 rounded-2xl shadow-lg border border-gray-700">
            <h2 class="text-3xl font-bold text-center text-white">ðŸŽ¨ Now, Your Turn to Visualize!</h2>
            <p class="mt-2 text-center text-gray-400 max-w-xl mx-auto">Go to the Krea.ai website and write a prompt to create a visual representation for each of the idioms we've learned. Share your most interesting photos with the class!</p>
            <div class="mt-6 text-center">
                <a href="https://www.krea.ai/" target="_blank" class="inline-block bg-purple-600 text-white font-semibold py-3 px-8 rounded-lg hover:bg-purple-700 transition-colors duration-200">Go to Krea.ai</a>
            </div>
             <p class="mt-4 text-xs text-gray-500 text-center">Example prompt for Krea.ai: "A metaphorical and artistic image representing the idiom 'to have money to burn'."</p>
        </section>

    </div>

    <script>
        const idioms = [
            {
                idiom: "Money to burn",
                theme: "Money",
                meaning: "To have a lot of extra money that you can spend on non-essential or luxury items without worrying.",
                example: "After he won the lottery, he started buying sports cars. He has money to burn.",
                imageUrl: "https://images.pexels.com/photos/1602726/pexels-photo-1602726.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1",
                alternatives: "rolling in it, made of money"
            },
            {
                idiom: "To make ends meet",
                theme: "Money",
                meaning: "To have just enough money to pay for basic living expenses like food and rent, with nothing left over.",
                example: "With the rising cost of groceries, many families are struggling to make ends meet.",
                imageUrl: "https://images.pexels.com/photos/6694543/pexels-photo-6694543.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1",
                alternatives: "to live from hand to mouth, to scrape by"
            },
            {
                idiom: "Cost an arm and a leg",
                theme: "Money",
                meaning: "To be extremely expensive.",
                example: "I'd love to buy that designer handbag, but it costs an arm and a leg.",
                imageUrl: "https://images.pexels.com/photos/3731256/pexels-photo-3731256.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1",
                alternatives: "to pay through the nose, to cost a fortune"
            },
            {
                idiom: "To be broke",
                theme: "Money",
                meaning: "To have absolutely no money.",
                example: "I can't go to the movies tonight, I'm completely broke until I get paid on Friday.",
                imageUrl: "https://images.pexels.com/photos/4386466/pexels-photo-4386466.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1",
                alternatives: "to be flat broke, to be penniless"
            },
            {
                idiom: "On the house",
                theme: "Money",
                meaning: "Free; given by a business at no cost.",
                example: "Because it was my birthday, the restaurant owner said our desserts were on the house.",
                imageUrl: "https://images.pexels.com/photos/3184183/pexels-photo-3184183.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1",
                alternatives: "complimentary, free of charge"
            }
        ];

        const idiomGrid = document.getElementById('idiom-grid');

        async function callGeminiWithExponentialBackoff(prompt, maxRetries = 5) {
            let delay = 1000;
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const apiKey = "";
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                    const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) {
                        if (response.status === 429 || response.status >= 500) { throw new Error(`API call failed with status: ${response.status}`); }
                        const errorResult = await response.json();
                        return `Error: ${errorResult.error?.message || 'An unknown error occurred.'}`;
                    }
                    const result = await response.json();
                    if (result.candidates && result.candidates[0]?.content?.parts?.[0]?.text) {
                        return result.candidates[0].content.parts[0].text;
                    }
                    return "Sorry, the model's response was empty.";
                } catch (error) {
                    if (i === maxRetries - 1) {
                        console.error("Gemini API call error after max retries:", error);
                        return "Sorry, an error occurred. Please try again later.";
                    }
                    await new Promise(res => setTimeout(res, delay));
                    delay *= 2;
                }
            }
        }
        
        idioms.forEach(item => {
            const cardContainer = document.createElement('div');
            cardContainer.className = 'idiom-card h-[450px] cursor-pointer group';

            cardContainer.innerHTML = `
                <div class="idiom-card-inner shadow-lg">
                    <div class="idiom-card-front bg-gray-800 p-6 text-center border-2 border-gray-700">
                        <div class="text-sm font-semibold uppercase tracking-wider text-purple-400">${item.theme}</div>
                        <h2 class="text-3xl font-bold text-white mt-4">${item.idiom}</h2>
                        <p class="mt-4 text-gray-400 italic">Click to reveal the story</p>
                    </div>
                    
                    <div class="idiom-card-back bg-gray-900 text-white p-6 flex flex-col border border-gray-700">
                         <img src="${item.imageUrl}" alt="Visual for ${item.idiom}" class="w-full h-32 object-cover rounded-lg mb-4 flex-shrink-0" onerror="this.onerror=null;this.src='https://placehold.co/600x400/374151/9ca3af?text=Image';">
                         
                         <div class="content-scroll-area flex-grow overflow-y-auto pr-2">
                             <h3 class="text-lg font-bold text-purple-400">Meaning:</h3>
                             <p class="text-sm mb-2 text-gray-300">${item.meaning}</p>
                             <h3 class="text-lg font-bold text-purple-400">Example:</h3>
                             <p class="text-sm italic mb-3 text-gray-400">"${item.example}"</p>
                             
                             <h3 class="text-lg font-bold text-purple-400">Similar Expressions:</h3>
                             <p class="text-sm text-gray-300">${item.alternatives}</p>

                             <div class="gemini-output bg-gray-800 p-3 mt-3 rounded-lg border border-gray-700">
                                 <div class="loader-container" style="display: none;"><div class="loader"></div></div>
                                 <div class="content-container text-sm text-gray-300"></div>
                             </div>
                         </div>

                        <button class="tell-story-btn mt-4 w-full bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-purple-700 transition-colors duration-200 flex-shrink-0">
                            âœ¨ Tell me a story
                        </button>
                    </div>
                </div>
            `;
            idiomGrid.appendChild(cardContainer);
        });

        document.addEventListener('click', async (e) => {
            const card = e.target.closest('.idiom-card');
            if (card && !e.target.closest('button')) {
                card.classList.toggle('is-flipped');
            }

            if (e.target.classList.contains('tell-story-btn')) {
                const button = e.target;
                const cardBack = button.closest('.idiom-card-back');
                const idiom = cardBack.closest('.idiom-card').querySelector('.idiom-card-front h2').textContent;
                const outputDiv = cardBack.querySelector('.gemini-output');
                const loader = outputDiv.querySelector('.loader-container');
                const content = outputDiv.querySelector('.content-container');

                button.disabled = true;
                button.classList.add('opacity-50', 'cursor-not-allowed');
                
                loader.style.display = 'block';
                content.innerHTML = '';
                outputDiv.style.maxHeight = '50px';

                const prompt = `Write a creative and very short story (2-3 sentences) at a B2 English level that uses the idiom "${idiom}". The story should be about money, crime, or love, and must clearly illustrate the idiom's meaning.`;
                const response = await callGeminiWithExponentialBackoff(prompt);
                
                content.innerHTML = response.replace(/\n/g, '<br>');
                loader.style.display = 'none';
                outputDiv.style.maxHeight = outputDiv.scrollHeight + 'px';

                button.disabled = false;
                button.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        });
    </script>

</body>
</html>

